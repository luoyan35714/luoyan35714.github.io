---
layout: post
title:  定时器之（二） - 定时器模块集群设计
date:   2015-06-18 15:06:00 +0800
categories: 技术文档
tag: 定时器设计
---

* content
{:toc}


定时器设计
-----------------------
基于前段时间[定时器初稿](/2015/04/30/timer-design/)的设计，已经在产品环境运行了一段时间，大概4个月吧。然后基于产品的定位改变，需求也要改变，需要引入定时器集群的概念。而分析了需求之后，得出了以下三套方案。

* 基于Quartz的集群

<p>
前一篇文章也说了，定时器前期做了很多的设计，但其实归根结底只是实现了一个简易的Quartz，而在需求增加的时候，刚好是个合适的时机，将原先的定时器用比较成熟的解决方案Quartz来代替。并且Quartz本身还支持集群。
</p>
* 基于令牌的自定义集群

<p>
这个是同事相处的一个方案，自己写的一套集群内服务器通讯。具体逻辑是，在每个服务中添加一个配置文件，把所有集群的IP全部配置进去（后期可以单独部署一个小的Server来获取所有的配置IP），并在第一台机器启动的时候把配置文件读取进去放入本地Queue中，当做Master，每台服务器的定时器运行前先去Master查询，是否有令牌可以执行，最先链接的获取令牌，master令牌相应减少，服务器执行完定时器的时候，再归还令牌，并且在这个过程中将master的令牌状态同步到Queue中的下一台。如果其中master挂掉了，就将Queue中的第二顺位作为master对待，原Master重新插入队尾。
</p>
* 基于Mesos的集群定时器

<p>
基于Mesos搭建一个独立的集群，然后将定时器部署在mesos上，而原服务器则不需要任何定时器相关逻辑，只需要暴漏接口，供外部调用。这样，当定时器触发的时候，Mesos只要基于商定好的接口调用，就可以实现定时器集群。
</p>

比较
=======================
作为集群的设计和开发，在保证功能和性能的前提下，更要保证的就是可用性，可靠性，灵活性，伸缩性和容错性。
<br/>
而基于这几点的考虑的话，Quartz的方案是基于数据库的，优点是与Spring无缝对接，方案比较成熟，部署在项目内部，开发快速。缺点是只支持单节点的定时器执行；非集群的定时器官方不建议存储在数据库，所以非集群的配置需要存储在内存中，增加了复杂性；并且quartz的定时器信息存储在数据库中，相当于是一个master节点，所以，除非在节点上修改trigger名字，否则定时器配置信息只能在数据库修改。灵活度比较低。

<br/>
基于令牌的自定义集群是不需要引入Quartz，即可以兼容现有的定时器设计，由于全部由自主开发，在代码扩展和维护方面更方便，缺点是如果master挂掉了，超时时间的浪费，会导致定时器在某些时间点运行滞后，并且，基于在某些特定场景下会出现多台Master共存的情况，容错性比较低。

<br />
基于Mesos的方案是比较完美的。但是缺点是开发周期会长一些，需要从头研究基于Mesos的定时器开发和部署。需要研究Mesos的集群技术，并且需要引入新的Server。新的环境，增加了实施人员的工作量。

结语
=============
说了这么多，最后决定使用的是基于Quartz的方案。原因很简单，项目中可以使用的时间短，相对来说Quartz的方案比较成熟。使用人多，并且开发人员更熟悉Quartz。而Quartz数据库方案对本项目的限制比较小，所以就是你了-Quartz集群

<br />
<br />